#!/usr/bin/env bash
# shellcheck shell=bash
#
# scripts/run

set -euo pipefail

ROOT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")/.." && pwd)"

source "$ROOT_DIR/scripts/lib/lib.sh"
source "$ROOT_DIR/scripts/lib/paths.sh"

usage() {
  cat >&2 <<EOF
Usage:
  scripts/run [mode] [--] [app args...]

Modes:
  (default)   Run built binary using .env
  test        Run built binary using .env.test
  live        Run with air (auto-reload) using .env
  debug       Run under Delve using .env

Notes:
  - Pass app arguments after '--' (recommended), e.g.:
      scripts/run -- --port=8080
      scripts/run test -- --seed=123
  - If the first token isn't a known mode, it's treated as an app arg.

Build artifact:
  $BIN_PATH
EOF
}

main() {
  case "${1:-}" in
  -h | --help | help)
    usage
    exit 0
    ;;
  esac

  mode="default"

  if [[ $# -gt 0 ]]; then
    case "$1" in
    default | test | live | debug)
      mode="$1"
      shift
      ;;
    --)
      shift
      ;;
    *)
      warn "Not a recognized mode. Running in default mode."
      mode="default"
      ;;
    esac
  fi

  if [[ "${1:-}" == "--" ]]; then
    shift
  fi

  app_args=("$@")

  require_build() {
    require_file "$BIN_PATH" "Refusing: binary not found at $BIN_PATH. Run 'scripts/build' first."
  }

  load_env_by_mode() {
    case "$mode" in
    test) load_env_file "$ROOT_DIR/.env.test" ;;
    *) load_env_file "$ROOT_DIR/.env" ;;
    esac
  }

  case "$mode" in
  default)
    load_env_by_mode
    require_build

    info "Running $BINARY_NAME ${app_args[*]:-}"
    exec "$BIN_PATH" "${app_args[@]}"
    ;;
  test)
    load_env_by_mode
    require_build

    info "Running $BINARY_NAME (test env) ${app_args[*]:-}"
    exec "$BIN_PATH" "${app_args[@]}"
    ;;
  live)
    need_cmd air
    load_env_file "$ROOT_DIR/.env"
    mkdir -p "$(dirname "$BIN_PATH")"

    AIR_ARGS="${app_args[*]:-}"
    export AIR_ARGS

    info "Running live reload via air ${app_args[*]:-}"
    exec air
    ;;
  debug)
    need_cmd dlv
    load_env_by_mode
    require_build

    info "Starting debugger (dlv exec) for $BINARY_NAME ${app_args[*]:-}"
    exec dlv exec "$BIN_PATH" -- "${app_args[@]}"
    ;;
  *)
    usage
    die "Unknown mode: $mode"
    ;;
  esac
}

main "$@"
