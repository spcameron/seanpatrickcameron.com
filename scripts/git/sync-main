#!/usr/bin/env bash
# shellcheck shell=bash
#
# scripts/git/sync-main

set -euo pipefail

ROOT_DIR="${ROOT_DIR:-$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")/../.." && pwd)}"

source "$ROOT_DIR/scripts/lib/lib.sh"
source "$ROOT_DIR/scripts/lib/git.sh"

main() {
  cd "$ROOT_DIR"

  need_cmd git
  require_clean

  info "Syncing main from origin/main (ff-only)..."

  local branch
  branch="$(git rev-parse --abbrev-ref HEAD)"

  if [[ "$branch" == "HEAD" ]]; then
    err "Refusing: detached HEAD (checkout a branch)."
    exit 1
  fi

  cleanup() {
    set +e
    if [[ "${branch:-}" != "main" && -n "${branch:-}" ]]; then
      if git show-ref --verify --quiet "refs/heads/$branch"; then
        git switch "$branch" >/dev/null 2>&1 || true
      fi
    fi
  }
  trap cleanup EXIT

  git fetch origin
  git switch main >/dev/null
  git merge --ff-only origin/main

  if [[ "$branch" != "main" ]]; then
    git switch "$branch" >/dev/null
  fi

  ok "... sync complete."
}

main "$@"
